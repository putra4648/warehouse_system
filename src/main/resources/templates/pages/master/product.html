<!DOCTYPE html>
<html lang="en" layout:decorate="~{layout/layout}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
  </head>
  <body>
    <div layout:fragment="content">
      <!-- Error dialog -->
      <div th:utext="${messageHTML}"></div>
      <div id="message"></div>

      <h1><strong>Master Product</strong></h1>
      <h6>Manage your product</h6>
      <hr />
      <h4 th:if="${message}" th:text="${message}"></h4>
      <div class="d-flex mb-3" style="gap: 6px">
        <button class="btn btn-primary" onclick="addProduct()">
          <i class="fas fa-plus"></i>
          <span>Add Product</span>
        </button>
      </div>

      <div class="card">
        <div id="master-product-table"></div>
      </div>

      <!-- Modal Add Product -->
      <div
        class="modal fade"
        id="add-master-product-modal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="exampleModalCenterTitle"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">
                Add Product
              </h5>
            </div>
            <form
              id="product-form"
              action="#"
              th:action="@{/master/product(action='add')}"
              th:object="${productForm}"
              method="post"
            >
              <div class="modal-body">
                <div class="form-group">
                  <label for="sku">SKU</label>
                  <input
                    class="form-control"
                    th:field="*{sku}"
                    aria-describedby="validateSKU"
                    th:classappend="${#fields.hasErrors('sku')} ? 'is-invalid' : ''"
                  />
                  <div
                    id="validateSKU"
                    class="invalid-feedback"
                    th:errors="*{sku}"
                  ></div>
                </div>
                <div class="form-group">
                  <label for="name">Name</label>
                  <input
                    class="form-control"
                    th:field="*{name}"
                    th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''"
                  />
                  <div
                    id="validateSKU"
                    class="invalid-feedback"
                    th:errors="*{name}"
                  ></div>
                </div>
                <div class="form-group">
                  <label for="description">Description</label>
                  <input class="form-control" th:field="*{description}" />
                </div>
                <div class="form-group">
                  <label for="min_stock">Min. Stock</label>
                  <input
                    min="0"
                    type="number"
                    class="form-control"
                    th:field="*{min_stock}"
                    th:classappend="${#fields.hasErrors('min_stock')} ? 'is-invalid' : ''"
                  />
                  <div
                    id="validateSKU"
                    class="invalid-feedback"
                    th:errors="*{min_stock}"
                  ></div>
                </div>
                <div class="form-group">
                  <label for="max_stock">Max Stock</label>
                  <input
                    min="1"
                    type="number"
                    class="form-control"
                    th:field="*{max_stock}"
                    th:classappend="${#fields.hasErrors('max_stock')} ? 'is-invalid' : ''"
                  />
                  <div
                    id="validateSKU"
                    class="invalid-feedback"
                    th:errors="*{max_stock}"
                  ></div>
                </div>
                <div class="form-group">
                  <input type="radio" th:field="*{is_active}" value="true" />
                  <label for="is_active">Enabled</label>
                </div>
                <div class="form-group">
                  <input type="radio" th:field="*{is_active}" value="false" />
                  <label for="is_active">Disabled</label>
                </div>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">Add</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Modal Delete Product -->
      <div
        class="modal fade"
        id="delete-master-product-modal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="exampleModalCenterTitle"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">
                Delete Product
              </h5>
            </div>
            <div class="modal-body">
              <h4>
                Are you sure to delete
                <strong id="sku-delete-modal"></strong> data?
              </h4>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
              <button
                type="submit"
                class="btn btn-danger"
                onclick="deleteProduct()"
              >
                Ok
              </button>
            </div>
          </div>
        </div>
      </div>

      <script th:inline="javascript">
        $("#master-product-table").tabulator({
          layout: "fitColumns",
          placeholder: "No Data Available",
          responsiveLayout: true,
          ajaxURL: "/api/master/product",
          pagination: true,
          paginationMode: "remote",
          paginationSize: 10,
          sortMode: "remote",
          ajaxConfig: "POST",
          ajaxContentType: "json",
          filterMode: "remote",
          columns: [
            {
              title: "SKU",
              field: "sku",
              minWidth: 100,
            },
            {
              title: "Name",
              field: "name",
              minWidth: 120,
            },
            {
              title: "Description",
              field: "description",
              minWidth: 100,
            },
            {
              title: "Min. Stock",
              field: "min_stock",
            },
            {
              title: "Max. Stock",
              field: "max_stock",
            },
            {
              title: "Category",
              field: "category_id",
            },
            {
              title: "Status",
              field: "status",
              formatter: (cell) => {
                const value = cell.getValue();
                return `<span class="badge badge-pill ${
                  value === "true" ? "badge-success" : "badge-danger"
                }">${value === "true" ? "Active" : "Inactive"}</span>`;
              },
            },
            {
              title: "Actions",
              headerSort: false,
              frozen: true,
              responsive: 0,
              minWidth: 100,
              formatter: (cell) => {
                return `<div class='d-flex' style='gap: 6px'>
                     <a class='btn btn-outline-secondary' href='${
                       "/master/product/" + cell.getData().sku
                     }'>
                       <i class='fas fa-edit'></i>
                     </a>
                     <button class='btn btn-outline-danger' onclick="showModalDeleteProduct('${
                       cell.getData().sku
                     }')">
                       <i class='fas fa-trash'></i>
                     </button>
                   </div>
                   `;
              },
            },
          ],
        });

        const showModal = /*[[${showModal}]]*/ "";

        if (showModal) {
          $("#product-form").prop("action", "/master/product?action=edit");
          $("#add-master-product-modal").modal("toggle");
        }

        function addProduct() {
          $("#product-form").trigger("reset");
          $("#product-form").prop("action", "/master/product?action=add");
          $("#add-master-product-modal").modal({
            backdrop: "static",
          });
        }

        function showModalDeleteProduct(sku) {
          const results = $("#master-product-table").tabulator(
            "searchData",
            "sku",
            "=",
            sku
          );

          if (results.length > 0) {
            $("#delete-master-product-modal").modal();
            $("#sku-delete-modal").html(results[0].sku);
            $("#product-form").find('input[name="sku"]').val(results[0].sku);
            $("#product-form").find('input[name="name"]').val(results[0].name);
            $("#product-form")
              .find('input[name="min_stock"]')
              .val(results[0].min_stock);
            $("#product-form")
              .find('input[name="max_stock"]')
              .val(results[0].max_stock);
          }
        }

        function deleteProduct() {
          $("#product-form").prop("action", "/master/product?action=delete");
          $("#product-form").trigger("submit");
        }
      </script>
    </div>
  </body>
</html>
