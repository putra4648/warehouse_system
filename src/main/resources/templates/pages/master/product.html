<!DOCTYPE html>
<html lang="en" layout:decorate="~{layout/layout}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
  </head>
  <body>
    <main layout:fragment="content">
      <div class="row g-2">
        <!-- Error dialog -->
        <div class="col-12">
          <div th:utext="${messageHTML}"></div>
          <div id="message"></div>
        </div>

        <div class="col-12">
          <h1><strong>Master Product</strong></h1>
          <h6>Manage your product</h6>
          <hr />
          <h4 th:if="${message}" th:text="${message}"></h4>
          <div class="d-flex mb-3" style="gap: 6px">
            <button class="btn btn-primary" onclick="addHandler()">
              <i class="fas fa-plus"></i>
              <span>Add Product</span>
            </button>
          </div>
        </div>

        <!-- Search -->
        <div class="col-12">
          <div class="card">
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
              <input
                class="form-control w-75"
                type="text"
                placeholder="Search product"
                onchange="handleTableChange(event)"
              />
              <!-- <select
                id="filter-table"
                class="form-select"
                aria-label="Filter table"
              >
                <option selected value="">Filter</option>
                <option value="sku">SKU</option>
                <option value="name">Name</option>
              </select> -->
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card">
            <div id="master-product-table"></div>
          </div>
        </div>

        <!-- Modal Add Product -->
        <div
          class="modal fade"
          id="add-master-product-modal"
          tabindex="-1"
          role="dialog"
          aria-labelledby="exampleModalCenterTitle"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">
                  Add Product
                </h5>
              </div>
              <form
                id="product-form"
                action="#"
                th:action="@{/master/product(action='add')}"
                th:object="${productForm}"
                method="post"
              >
                <div class="modal-body">
                  <div class="form-group">
                    <label for="sku">SKU</label>
                    <input
                      class="form-control"
                      th:field="*{sku}"
                      aria-describedby="validateSKU"
                      th:classappend="${#fields.hasErrors('sku')} ? 'is-invalid' : ''"
                    />
                    <div
                      id="validateSKU"
                      class="invalid-feedback"
                      th:errors="*{sku}"
                    ></div>
                  </div>
                  <div class="form-group">
                    <label for="name">Name</label>
                    <input
                      class="form-control"
                      th:field="*{name}"
                      th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''"
                    />
                    <div
                      id="validateSKU"
                      class="invalid-feedback"
                      th:errors="*{name}"
                    ></div>
                  </div>
                  <div class="form-group">
                    <label for="description">Description</label>
                    <input class="form-control" th:field="*{description}" />
                  </div>
                  <div class="form-group">
                    <label for="minStock">Min. Stock</label>
                    <input
                      min="0"
                      type="number"
                      class="form-control"
                      th:field="*{minStock}"
                      th:classappend="${#fields.hasErrors('minStock')} ? 'is-invalid' : ''"
                    />
                    <div
                      id="validateSKU"
                      class="invalid-feedback"
                      th:errors="*{minStock}"
                    ></div>
                  </div>
                  <div class="form-group">
                    <label for="maxStock">Max Stock</label>
                    <input
                      min="1"
                      type="number"
                      class="form-control"
                      th:field="*{maxStock}"
                      th:classappend="${#fields.hasErrors('maxStock')} ? 'is-invalid' : ''"
                    />
                    <div
                      id="validateSKU"
                      class="invalid-feedback"
                      th:errors="*{maxStock}"
                    ></div>
                  </div>
                  <label class="form-label">Status</label>
                  <div class="form-check">
                    <input type="radio" th:field="*{isActive}" value="true" />
                    <label for="isActive">Enabled</label>
                  </div>
                  <div class="form-check">
                    <input type="radio" th:field="*{isActive}" value="false" />
                    <label for="isActive">Disabled</label>
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                    data-bs-target="#add-master-product-modal"
                  >
                    Cancel
                  </button>
                  <button type="submit" class="btn btn-primary">Add</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Modal Delete Product -->
        <dialog
          class="modal fade"
          id="delete-master-product-modal"
          tabindex="-1"
          aria-labelledby="exampleModalCenterTitle"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">
                  Delete Product
                </h5>
              </div>
              <div class="modal-body">
                <h4>
                  Are you sure to delete
                  <strong id="sku-delete-modal"></strong> data?
                </h4>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-dismiss="modal"
                >
                  Close
                </button>
                <button
                  type="submit"
                  class="btn btn-danger"
                  onclick="deleteProduct()"
                >
                  Ok
                </button>
              </div>
            </div>
          </div>
        </dialog>

        <script th:inline="javascript">
          const table = new Tabulator("#master-product-table", {
            layout: "fitColumns",
            placeholder: "No Data Available",
            responsiveLayout: true,
            ajaxURL: "/api/master/product",
            pagination: true,
            paginationMode: "remote",
            paginationSize: 10,
            sortMode: "remote",
            ajaxConfig: "POST",
            ajaxContentType: "json",
            filterMode: "remote",
            dataReceiveParams: {
              last_page: "lastPage",
            },
            columns: [
              {
                title: "SKU",
                field: "sku",
                minWidth: 100,
              },
              {
                title: "Name",
                field: "name",
                minWidth: 120,
              },
              {
                title: "Description",
                field: "description",
                minWidth: 100,
              },
              {
                title: "Min. Stock",
                field: "minStock",
                formatter: "money",
                formatterParams: {
                  decimal: ",",
                  thousand: ".",
                  negativeSign: true,
                  precision: false,
                },
              },
              {
                title: "Max. Stock",
                field: "maxStock",
                formatter: "money",
                formatterParams: {
                  decimal: ",",
                  thousand: ".",
                  negativeSign: true,
                  precision: false,
                },
              },
              {
                title: "Category",
                field: "category_id",
              },
              {
                title: "Status",
                field: "status",
                formatter: (cell) => {
                  const value = cell.getValue();
                  return `<span class="badge rounded-pill ${
                    value === "true" ? "text-bg-success" : "text-bg-danger"
                  }">${value === "true" ? "Active" : "Inactive"}</span>`;
                },
              },
              {
                title: "Actions",
                headerSort: false,
                frozen: true,
                responsive: 0,
                minWidth: 100,
                formatter: (cell) => {
                  return `<div class='d-flex' style='gap: 6px'>
                     <button class='btn btn-outline-secondary' onclick="showModalEditProduct('${
                       cell.getData().sku
                     }')">
                       <i class='fas fa-edit'></i>
                     </a>
                     <button class='btn btn-outline-danger' onclick="showModalDeleteProduct('${
                       cell.getData().sku
                     }')">
                       <i class='fas fa-trash'></i>
                     </button>
                   </div>
                   `;
                },
              },
            ],
          });

          function handleTableChange(event) {
            const filterBy = $("#filter-table").val();
            table.setFilter(filterBy, "like", event.target.value);
          }

          function addHandler() {
            console.log("Add Product");
            $("#product-form").trigger("reset");
            $("#product-form").prop("action", "/master/product?action=add");
            $("#add-master-product-modal").modal("show");
          }

          function showModalDeleteProduct(sku) {
            const results = table.searchData("sku", "=", sku);

            if (results.length > 0) {
              $("#delete-master-product-modal").modal();
              $("#sku-delete-modal").html(results[0].sku);
              $("#product-form").find('input[name="sku"]').val(results[0].sku);
              $("#product-form")
                .find('input[name="name"]')
                .val(results[0].name);
              $("#product-form")
                .find('input[name="minStock"]')
                .val(results[0].minStock);
              $("#product-form")
                .find('input[name="maxStock"]')
                .val(results[0].maxStock);
            }
          }

          function showModalEditProduct(sku) {
            const results = table.searchData("sku", "=", sku);

            if (results.length > 0) {
              $("#product-form").prop("action", "/master/product?action=edit");
              $("#add-master-product-modal").modal("toggle");
              $("#product-form").find('input[name="sku"]').val(results[0].sku);
              $("#product-form")
                .find('input[name="name"]')
                .val(results[0].name);
              $("#product-form")
                .find('input[name="description"]')
                .val(results[0].description);
              $("#product-form")
                .find('input[name="minStock"]')
                .val(results[0].minStock);
              $("#product-form")
                .find('input[name="maxStock"]')
                .val(results[0].maxStock);
            }
          }

          function deleteProduct() {
            $("#product-form").prop("action", "/master/product?action=delete");
            $("#product-form").trigger("submit");
          }
        </script>
      </div>
    </main>
  </body>
</html>
